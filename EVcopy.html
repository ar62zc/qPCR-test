<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EVs Copy Number Calculator Pro</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 1. React & ReactDOM (Core) -->
    <script src="https://unpkg.com/react@18.2.0/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18.2.0/umd/react-dom.production.min.js" crossorigin></script>
    
    <!-- 2. Prop Types (Required by Recharts UMD) -->
    <script src="https://unpkg.com/prop-types@15.8.1/prop-types.min.js"></script>

    <!-- 3. Recharts (Charting Library - Fixed Version) -->
    <script src="https://unpkg.com/recharts@2.12.7/umd/Recharts.js"></script>
    
    <!-- 4. Babel (JSX Transformer) -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Global Error Handler & Styles -->
    <style>
        body { font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; }
        /* Loading Spinner */
        #root-loader {
            position: fixed; inset: 0; background: #f8fafc; z-index: 9999;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
        .spinner {
            width: 50px; height: 50px; border: 5px solid #cbd5e1; border-top-color: #0d9488;
            border-radius: 50%; animation: spin 1s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        /* Error Box */
        #global-error {
            display: none; position: fixed; top: 0; left: 0; right: 0; padding: 20px;
            background-color: #fee2e2; border-bottom: 2px solid #ef4444; color: #991b1b;
            z-index: 10000; font-family: monospace;
            white-space: pre-wrap;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
    </style>
    <script>
        window.onerror = function(message, source, lineno, colno, error) {
            const errorBox = document.getElementById('global-error');
            const errorText = document.getElementById('error-text');
            const loader = document.getElementById('root-loader');
            
            if (errorBox && errorText) {
                if (loader) loader.style.display = 'none'; // Hide loader
                errorBox.style.display = 'block';
                errorText.innerText = `Error: ${message}\nSource: ${source}:${lineno}:${colno}\n\n${error ? error.stack : ''}`;
            }
            return false;
        };
    </script>
</head>
<body class="bg-slate-50 text-slate-800">

    <!-- Loading Screen -->
    <div id="root-loader">
        <div class="spinner"></div>
        <p class="mt-4 text-slate-500 font-medium">Loading Application...</p>
    </div>

    <!-- Error Display -->
    <div id="global-error">
        <h3 class="font-bold text-lg mb-2 flex items-center gap-2">
            ⚠️ Application Error
        </h3>
        <pre id="error-text" class="text-sm overflow-auto max-h-[80vh] p-2 bg-red-50 rounded border border-red-200"></pre>
        <div class="mt-4 flex gap-2">
            <button onclick="window.location.reload()" class="px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700 transition-colors font-medium">Reload Page</button>
        </div>
    </div>

    <!-- App Root -->
    <div id="root"></div>

    <!-- React Application -->
    <script type="text/babel">
        // Safety check for dependencies
        if (!window.React || !window.ReactDOM || !window.Recharts) {
            throw new Error("Critical dependencies (React, ReactDOM, or Recharts) failed to load. Please check your internet connection or CDN status.");
        }

        const { useState, useEffect, useMemo } = React;
        const { LineChart, Line, XAxis, YAxis, CartesianGrid, Tooltip, Legend, ResponsiveContainer, Scatter } = Recharts;

        // ==========================================
        // CONFIG: Language & Translations
        // 您可以在這裡修改顯示的文字
        // ==========================================
        const TRANSLATIONS = {
            zh: {
                title: "EVs Copy Number Calculator",
                pro_badge: "Pro",
                tab_std: "1. 標準曲線",
                tab_sample: "2. 單一計算",
                tab_batch: "3. 批量計算",
                // Standard Tab
                settings_data: "設定與數據",
                excel_paste: "Excel 貼上",
                cancel: "取消",
                auto_optimize: "自動優化",
                std_type: "Standard Type",
                std_size: "Standard Size",
                paste_instruction: "請從 Excel 複製兩欄數據 (不含標題)，第一欄為 Mass，第二欄為 Ct，然後貼在下方。",
                paste_placeholder: "1.0\t15.5\n0.1\t19.1\n0.01\t22.4",
                confirm_import: "確認匯入",
                error_format_std: "無法識別有效的數據格式。請確認複製內容包含兩欄數字：Mass 與 Ct。",
                col_mass: "Mass (ng/well)",
                col_ct: "Ct Value",
                col_del: "刪除",
                btn_add_point: "+ 新增點",
                // Chart Stats
                chart_title: "Standard Curve",
                legend_included: "Included",
                legend_excluded: "Excluded",
                // Sample Tab
                sample_params: "樣本參數",
                warning_no_std: "請先到「標準曲線」分頁完成數據輸入與計算。",
                ev_input: "EVs 起始總量 (Number of EVs)",
                scientific_notation: "Scientific notation",
                rna_extraction: "RNA Extraction",
                eluted_conc: "Eluted Concentration",
                elution_vol: "Elution Volume",
                qpcr_reaction: "qPCR Reaction",
                input_rna_mass: "Input RNA Mass",
                target_product: "Target Product",
                target_diff_hint: "* 如果 Target 大小與 Standard 不同，請在此修正，以計算準確的 Target Mass per EV。",
                sample_ct: "Sample Ct Value",
                analysis_report: "分析報告",
                reset: "重置",
                waiting_input: "等待輸入完整數據...",
                copies_per_ev: "Copies per EV",
                target_gene_copies: "Target Gene Copies / EV",
                target_mass_per_ev: "Target Mass per EV",
                specific_target_mass: "Specific Target Mass",
                total_rna_yield: "Total RNA Yield per EV",
                derived_bulk: "Derived from Extraction Conc. (Bulk RNA)",
                traceability: "中間數據 (Traceability)",
                est_copies_well: "Est. Copies in qPCR Well:",
                total_rna_yield_val: "Total RNA Yield:",
                total_copies_sample: "Total Copies in Sample:",
                sample_mw_used: "Sample MW Used:",
                // Batch Tab
                batch_warning_title: "尚未建立標準曲線",
                batch_warning_desc: "請先回到「分頁 1」輸入標準品數據，系統將使用該曲線來計算下列樣本。",
                view_table: "檢視結果表格",
                paste_batch_data: "貼上 Excel 數據",
                batch_input_title: "批量數據輸入",
                batch_instruction: "請從 Excel 複製以下順序的欄位 (不含標題):",
                batch_cols: "Sample Name | EV Input | RNA Conc | Vol | qPCR Mass | Ct Value",
                batch_example: "例如: Sample_01 | 1.0E+09 | 15.5 | 12 | 10 | 24.5",
                batch_placeholder: "Sample_1\t1000000000\t15.5\t12\t10\t24.5\nSample_2\t500000000\t12.1\t12\t10\t26.1",
                start_calc: "開始計算",
                error_format_batch: "無法識別數據。請確認格式：Name | EVs | Conc | Vol | Mass | Ct",
                error_no_std: "請先建立標準曲線！",
                no_results: "暫無計算結果",
                copy_hint: "* 可直接選取表格內容並複製回 Excel",
                col_name: "Sample Name",
                // Common
                units_particles: "particles",
            },
            en: {
                title: "EVs Copy Number Calculator",
                pro_badge: "Pro",
                tab_std: "1. Standard Curve",
                tab_sample: "2. Single Calc",
                tab_batch: "3. Batch Calc",
                settings_data: "Settings & Data",
                excel_paste: "Excel Paste",
                cancel: "Cancel",
                auto_optimize: "Auto Optimize",
                std_type: "Standard Type",
                std_size: "Standard Size",
                paste_instruction: "Copy two columns (Mass, Ct) from Excel without headers and paste below.",
                paste_placeholder: "1.0\t15.5\n0.1\t19.1\n0.01\t22.4",
                confirm_import: "Import Data",
                error_format_std: "Invalid format. Please ensure two columns of numbers: Mass and Ct.",
                col_mass: "Mass (ng/well)",
                col_ct: "Ct Value",
                col_del: "Del",
                btn_add_point: "+ Add Point",
                chart_title: "Standard Curve",
                legend_included: "Included",
                legend_excluded: "Excluded",
                sample_params: "Sample Parameters",
                warning_no_std: "Please complete data entry in the 'Standard Curve' tab first.",
                ev_input: "Total EVs Input",
                scientific_notation: "Scientific notation",
                rna_extraction: "RNA Extraction",
                eluted_conc: "Eluted Concentration",
                elution_vol: "Elution Volume",
                qpcr_reaction: "qPCR Reaction",
                input_rna_mass: "Input RNA Mass",
                target_product: "Target Product",
                target_diff_hint: "* Adjust if Target size differs from Standard to calculate accurate Target Mass.",
                sample_ct: "Sample Ct Value",
                analysis_report: "Analysis Report",
                reset: "Reset",
                waiting_input: "Waiting for complete data...",
                copies_per_ev: "Copies per EV",
                target_gene_copies: "Target Gene Copies / EV",
                target_mass_per_ev: "Target Mass per EV",
                specific_target_mass: "Specific Target Mass",
                total_rna_yield: "Total RNA Yield per EV",
                derived_bulk: "Derived from Extraction Conc. (Bulk RNA)",
                traceability: "Traceability Data",
                est_copies_well: "Est. Copies in qPCR Well:",
                total_rna_yield_val: "Total RNA Yield:",
                total_copies_sample: "Total Copies in Sample:",
                sample_mw_used: "Sample MW Used:",
                batch_warning_title: "No Standard Curve",
                batch_warning_desc: "Please go to 'Tab 1' and input standard data first.",
                view_table: "View Table",
                paste_batch_data: "Paste Excel Data",
                batch_input_title: "Batch Data Input",
                batch_instruction: "Copy columns in this order from Excel (no headers):",
                batch_cols: "Sample Name | EV Input | RNA Conc | Vol | qPCR Mass | Ct Value",
                batch_example: "Ex: Sample_01 | 1.0E+09 | 15.5 | 12 | 10 | 24.5",
                batch_placeholder: "Sample_1\t1000000000\t15.5\t12\t10\t24.5\nSample_2\t500000000\t12.1\t12\t10\t26.1",
                start_calc: "Calculate",
                error_format_batch: "Invalid format. Ensure: Name | EVs | Conc | Vol | Mass | Ct",
                error_no_std: "Please establish a standard curve first!",
                no_results: "No results yet",
                copy_hint: "* You can select the table and copy it back to Excel.",
                col_name: "Sample Name",
                units_particles: "particles",
            }
        };

        // ==========================================
        // ICONS: Inline SVG Components
        // ==========================================
        const IconBase = ({ size = 24, className = "", children }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                {children}
            </svg>
        );

        const FlaskConical = (props) => (
            <IconBase {...props}><path d="M10 2v7.527a2 2 0 0 1-.211.896L4.72 20.55a1 1 0 0 0 .9 1.45h12.76a1 1 0 0 0 .9-1.45l-5.069-10.127A2 2 0 0 1 14 9.527V2"/><path d="M8.5 2h7"/><path d="M7 16h10"/></IconBase>
        );
        const Calculator = (props) => (
            <IconBase {...props}><rect width="16" height="20" x="4" y="2" rx="2"/><line x1="8" x2="16" y1="6" y2="6"/><line x1="16" x2="16" y1="14" y2="18"/><path d="M16 10h.01"/><path d="M12 10h.01"/><path d="M8 10h.01"/><path d="M12 14h.01"/><path d="M8 14h.01"/><path d="M12 18h.01"/><path d="M8 18h.01"/></IconBase>
        );
        const Dna = (props) => (
            <IconBase {...props}><path d="m2 15 6 5.8a6.5 6.5 0 0 0 8.5-1.5A6.5 6.5 0 0 0 18 13.7L22 10m-6.4 5.9-2.3 2.5m-3.8-11.2 2.3 2.5m5.8-6.1a6.5 6.5 0 0 0-8.5 1.5A6.5 6.5 0 0 0 5 8.3L2 11"/><path d="m15 2 1 2"/><path d="m20 7 2 2"/><path d="m6 18-2 2"/><path d="m2 2 2 2"/><path d="m11 6 2 2"/><path d="m8 20 2 2"/></IconBase>
        );
        const ArrowRight = (props) => (
            <IconBase {...props}><path d="M5 12h14"/><path d="m12 5 7 7-7 7"/></IconBase>
        );
        const Info = (props) => (
            <IconBase {...props}><circle cx="12" cy="12" r="10"/><path d="M12 16v-4"/><path d="M12 8h.01"/></IconBase>
        );
        const Copy = (props) => (
            <IconBase {...props}><rect width="14" height="14" x="8" y="8" rx="2" ry="2"/><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"/></IconBase>
        );
        const RotateCcw = (props) => (
            <IconBase {...props}><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 12"/><path d="M3 3v9h9"/></IconBase>
        );
        const Filter = (props) => (
            <IconBase {...props}><polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"/></IconBase>
        );
        const ClipboardPaste = (props) => (
            <IconBase {...props}><path d="M15 2H9a1 1 0 0 0-1 1v2c0 .55.45 1 1 1h6c.55 0 1-.45 1-1V3a1 1 0 0 0-1-1Z"/><path d="M8 4H6a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2M16 4h2a2 2 0 0 1 2 2v2M11 14h10"/><path d="m17 10 4 4-4 4"/></IconBase>
        );
        const X = (props) => (
            <IconBase {...props}><path d="M18 6 6 18"/><path d="m6 6 12 12"/></IconBase>
        );
        const TableIcon = (props) => (
            <IconBase {...props}><path d="M12 3v18"/><rect width="18" height="18" x="3" y="3" rx="2"/><path d="M3 9h18"/><path d="M3 15h18"/></IconBase>
        );
        const FileSpreadsheet = (props) => (
            <IconBase {...props}><path d="M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7Z"/><path d="M14 2v4a1 1 0 0 0 1 1h4"/><path d="M8 13h2"/><path d="M8 17h2"/><path d="M14 13h2"/><path d="M14 17h2"/></IconBase>
        );
        const Globe = (props) => (
            <IconBase {...props}><circle cx="12" cy="12" r="10"/><path d="M12 2a14.5 14.5 0 0 0 0 20 14.5 14.5 0 0 0 0-20"/><path d="M2 12h20"/></IconBase>
        );

        // ==========================================
        // MAIN APP COMPONENT
        // ==========================================
        const App = () => {
            const [lang, setLang] = useState('zh');
            const [activeTab, setActiveTab] = useState('standard');

            // Translation Helper
            const t = (key) => TRANSLATIONS[lang][key] || key;
            const toggleLang = () => setLang(prev => prev === 'zh' ? 'en' : 'zh');

            // --- State: Standard Curve ---
            const [stdType, setStdType] = useState('ssRNA');
            const [stdUnit, setStdUnit] = useState('bp'); // bp or kDa
            const [stdSize, setStdSize] = useState(22); 
            const [showPasteArea, setShowPasteArea] = useState(false);
            const [pasteInput, setPasteInput] = useState(''); 

            const [standards, setStandards] = useState([
                { id: 1, quantity: 1, ct: 15.5, included: true },
                { id: 2, quantity: 0.1, ct: 19.1, included: true },
                { id: 3, quantity: 0.01, ct: 22.4, included: true },
                { id: 4, quantity: 0.001, ct: 25.8, included: true },
                { id: 5, quantity: 0.0001, ct: 29.2, included: true },
                { id: 6, quantity: 0.00001, ct: 35.5, included: true }, 
            ]);

            // --- State: Single Sample Calculation ---
            const [evInput, setEvInput] = useState(1e9); 
            const [rnaConc, setRnaConc] = useState(15.5); 
            const [rnaVol, setRnaVol] = useState(12); 
            const [qpcrInputMass, setQpcrInputMass] = useState(10); 
            const [sampleCt, setSampleCt] = useState(24.5);
            
            // Target Product Config
            const [targetSize, setTargetSize] = useState(22); 
            const [targetType, setTargetType] = useState('ssRNA'); 

            // --- State: Batch Calculation ---
            const [batchPasteInput, setBatchPasteInput] = useState('');
            const [batchSamples, setBatchSamples] = useState([]); 
            const [showBatchPaste, setShowBatchPaste] = useState(true);

            // --- Constants ---
            const AVOGADRO = 6.022e23;

            // --- Helpers ---
            const calculateMW = (size, unit, type) => {
                if (unit === 'kDa') return size * 1000;
                if (type === 'ssRNA') return size * 320.5 + 159; 
                if (type === 'dsDNA') return size * 617.96 + 36.04; 
                return size;
            };

            const massToCopies = (massNg, size, unit, type) => {
                if (!massNg || !size) return 0;
                const mw = calculateMW(size, unit, type);
                return (massNg * 1e-9 * AVOGADRO) / mw;
            };

            const copiesToMassPg = (copies, size, unit, type) => {
                if (!copies || !size) return 0;
                const mw = calculateMW(size, unit, type); // g/mol
                const massG = (copies * mw) / AVOGADRO;
                return massG * 1e12; // convert g to pg
            };

            // Regression Analysis
            const regressionParams = useMemo(() => {
                const validPoints = standards.filter(p => p.quantity > 0 && p.ct > 0 && p.included);
                validPoints.sort((a, b) => b.quantity - a.quantity);

                if (validPoints.length < 2) return { slope: null, intercept: null, r2: null, efficiency: null, validPoints: [] };

                const data = validPoints.map(p => ({
                    x: Math.log2(massToCopies(p.quantity, stdSize, stdUnit, stdType)),
                    y: p.ct,
                    original: p
                }));

                const n = data.length;
                const sumX = data.reduce((a, b) => a + b.x, 0);
                const sumY = data.reduce((a, b) => a + b.y, 0);
                const sumXY = data.reduce((a, b) => a + (b.x * b.y), 0);
                const sumXX = data.reduce((a, b) => a + (b.x * b.x), 0);
                const sumYY = data.reduce((a, b) => a + (b.y * b.y), 0);

                const slope = (n * sumXY - sumX * sumY) / (n * sumXX - sumX * sumX);
                const intercept = (sumY - slope * sumX) / n;

                const numerator = (n * sumXY - sumX * sumY);
                const denominator = Math.sqrt((n * sumXX - sumX * sumX) * (n * sumYY - sumY * sumY));
                const r2 = denominator === 0 ? 0 : Math.pow(numerator / denominator, 2);
                const efficiency = (Math.pow(2, -1 / slope) - 1) * 100;

                return { slope, intercept, r2, efficiency, validPoints };
            }, [standards, stdSize, stdUnit, stdType]);

            // --- Single Sample Results Calculation ---
            const results = useMemo(() => {
                if (!regressionParams.slope || !evInput || !rnaConc || !rnaVol || !qpcrInputMass || !sampleCt) {
                    return null;
                }
                const logCopies = (sampleCt - regressionParams.intercept) / regressionParams.slope;
                const copiesInWell = Math.pow(2, logCopies);
                const totalRnaYieldNg = rnaConc * rnaVol;
                const fractionUsed = qpcrInputMass / totalRnaYieldNg;
                const totalCopiesInEluate = copiesInWell / fractionUsed;
                const totalRnaMassPerEv = (totalRnaYieldNg * 1000) / evInput;
                const copiesPerEv = totalCopiesInEluate / evInput;
                const targetMassPerEvPg = copiesToMassPg(copiesPerEv, targetSize, stdUnit, targetType);

                return {
                    copiesInWell, totalRnaYieldNg, totalCopiesInEluate, totalRnaMassPerEv, targetMassPerEvPg, copiesPerEv
                };
            }, [regressionParams, evInput, rnaConc, rnaVol, qpcrInputMass, sampleCt, targetSize, targetType, stdUnit]);

            // --- Handlers ---
            const handleStandardChange = (id, field, value) => {
                const newStds = standards.map(s => s.id === id ? { ...s, [field]: field === 'included' ? value : parseFloat(value) } : s);
                setStandards(newStds);
            };

            const addStandard = () => {
                const nextId = Math.max(...standards.map(s => s.id), 0) + 1;
                setStandards([...standards, { id: nextId, quantity: 0, ct: 0, included: true }]);
            };

            const removeStandard = (id) => {
                setStandards(standards.filter(s => s.id !== id));
            };

            const handlePasteProcess = () => {
                if (!pasteInput) return;
                const lines = pasteInput.trim().split(/\r\n|\n|\r/);
                const newStds = [];
                let currentId = 1;
                lines.forEach(line => {
                    const parts = line.trim().split(/[\t,]+| +/); 
                    if (parts.length >= 2) {
                        const qty = parseFloat(parts[0]);
                        const ct = parseFloat(parts[1]);
                        if (!isNaN(qty) && !isNaN(ct)) {
                            newStds.push({ id: currentId++, quantity: qty, ct: ct, included: true });
                        }
                    }
                });

                if (newStds.length > 0) {
                    setStandards(newStds);
                    setShowPasteArea(false);
                    setPasteInput('');
                } else {
                    alert(t('error_format_std'));
                }
            };

            const handleBatchPasteProcess = () => {
                if (!batchPasteInput || !regressionParams.slope) {
                    if(!regressionParams.slope) alert(t('error_no_std'));
                    return;
                }
                const lines = batchPasteInput.trim().split(/\r\n|\n|\r/);
                const processedSamples = [];
                lines.forEach((line, index) => {
                    const parts = line.trim().split(/[\t,]+/);
                    if (parts.length >= 6 && !isNaN(parseFloat(parts[1]))) {
                        const name = parts[0];
                        const evIn = parseFloat(parts[1]);
                        const rnaC = parseFloat(parts[2]);
                        const rnaV = parseFloat(parts[3]);
                        const qpcrM = parseFloat(parts[4]);
                        const ct = parseFloat(parts[5]);

                        if (!isNaN(ct) && !isNaN(evIn) && !isNaN(rnaC) && !isNaN(rnaV) && !isNaN(qpcrM)) {
                            const logCopies = (ct - regressionParams.intercept) / regressionParams.slope;
                            const copiesInWell = Math.pow(2, logCopies);
                            const totalRnaYieldNg = rnaC * rnaV;
                            const fractionUsed = qpcrM / totalRnaYieldNg;
                            const totalCopiesInEluate = copiesInWell / fractionUsed;
                            const copiesPerEv = totalCopiesInEluate / evIn;
                            const targetMassPerEvPg = copiesToMassPg(copiesPerEv, targetSize, stdUnit, targetType);

                            processedSamples.push({
                                id: index, name, evIn, rnaC, rnaV, qpcrM, ct, copiesPerEv, targetMassPerEvPg
                            });
                        }
                    }
                });

                if (processedSamples.length > 0) {
                    setBatchSamples(processedSamples);
                    setShowBatchPaste(false);
                    setBatchPasteInput('');
                } else {
                    alert(t('error_format_batch'));
                }
            };

            const autoOptimize = () => {
                const sortedStds = [...standards].sort((a, b) => b.quantity - a.quantity);
                const n = sortedStds.length;
                if (n < 3) return;

                let bestR2 = -1;
                let bestSubsetMask = new Array(n).fill(true);

                for (let i = 0; i < n; i++) {
                    for (let j = i + 2; j < n; j++) {
                        const subset = sortedStds.slice(i, j + 1);
                        const data = subset.map(p => ({
                            x: Math.log2(massToCopies(p.quantity, stdSize, stdUnit, stdType)),
                            y: p.ct
                        }));
                        
                        const subN = data.length;
                        const sumX = data.reduce((a, b) => a + b.x, 0);
                        const sumY = data.reduce((a, b) => a + b.y, 0);
                        const sumXY = data.reduce((a, b) => a + (b.x * b.y), 0);
                        const sumXX = data.reduce((a, b) => a + (b.x * b.x), 0);
                        const sumYY = data.reduce((a, b) => a + (b.y * b.y), 0);
                        
                        const numerator = (subN * sumXY - sumX * sumY);
                        const denominator = Math.sqrt((subN * sumXX - sumX * sumX) * (subN * sumYY - sumY * sumY));
                        const r2 = denominator === 0 ? 0 : Math.pow(numerator / denominator, 2);

                        if (r2 > bestR2) {
                            bestR2 = r2;
                            bestSubsetMask = sortedStds.map((_, idx) => idx >= i && idx <= j);
                        }
                    }
                }

                const optimizedStandards = standards.map(std => {
                    const sortedIndex = sortedStds.findIndex(s => s.id === std.id);
                    return { ...std, included: bestSubsetMask[sortedIndex] };
                });
                setStandards(optimizedStandards);
            };

            // Remove loading screen on mount
            useEffect(() => {
                const loader = document.getElementById('root-loader');
                if(loader) loader.style.display = 'none';
            }, []);

            return (
                <div className="min-h-screen bg-slate-50 font-sans text-slate-800 p-4 md:p-8">
                <div className="max-w-6xl mx-auto">
                    
                    {/* Header */}
                    <header className="mb-6 flex flex-col md:flex-row md:items-center justify-between gap-4">
                    <div>
                        <h1 className="text-2xl md:text-3xl font-bold text-slate-900 flex items-center gap-3">
                        <FlaskConical className="text-teal-600 h-8 w-8" />
                        {t('title')} <span className="text-xs bg-teal-100 text-teal-700 px-2 py-1 rounded-full align-middle">{t('pro_badge')}</span>
                        </h1>
                    </div>
                    <div className="flex flex-wrap gap-2 items-center">
                         {/* Lang Switch */}
                        <button onClick={toggleLang} className="mr-2 px-3 py-2 bg-slate-200 hover:bg-slate-300 rounded-lg text-slate-700 flex items-center gap-2 text-sm font-medium transition-colors">
                            <Globe size={16} /> {lang === 'zh' ? 'English' : '中文'}
                        </button>

                        <button
                            onClick={() => setActiveTab('standard')}
                            className={`px-4 py-2 rounded-lg font-medium text-sm transition-colors flex items-center gap-2 ${
                            activeTab === 'standard' 
                                ? 'bg-teal-600 text-white shadow-md' 
                                : 'bg-white text-slate-600 border border-slate-200 hover:bg-slate-50'
                            }`}
                        >
                            <Dna size={16} />
                            {t('tab_std')}
                        </button>
                        <button
                            onClick={() => setActiveTab('sample')}
                            className={`px-4 py-2 rounded-lg font-medium text-sm transition-colors flex items-center gap-2 ${
                            activeTab === 'sample' 
                                ? 'bg-teal-600 text-white shadow-md' 
                                : 'bg-white text-slate-600 border border-slate-200 hover:bg-slate-50'
                            }`}
                        >
                            <Calculator size={16} />
                            {t('tab_sample')}
                        </button>
                        <button
                            onClick={() => setActiveTab('batch')}
                            className={`px-4 py-2 rounded-lg font-medium text-sm transition-colors flex items-center gap-2 ${
                            activeTab === 'batch' 
                                ? 'bg-teal-600 text-white shadow-md' 
                                : 'bg-white text-slate-600 border border-slate-200 hover:bg-slate-50'
                            }`}
                        >
                            <TableIcon size={16} />
                            {t('tab_batch')}
                        </button>
                    </div>
                    </header>

                    {/* --- TAB 1: STANDARD CURVE --- */}
                    {activeTab === 'standard' && (
                    <div className="grid lg:grid-cols-12 gap-6 animate-[fadeIn_0.3s_ease-out]">
                        
                        {/* Input Panel (Left) */}
                        <div className="lg:col-span-5 bg-white p-5 rounded-xl shadow-sm border border-slate-100 flex flex-col h-fit relative">
                        
                        <div className="flex justify-between items-center mb-4">
                            <h2 className="text-lg font-semibold flex items-center gap-2">
                            {t('settings_data')}
                            </h2>
                            <div className="flex gap-2">
                            <button 
                                onClick={() => setShowPasteArea(!showPasteArea)}
                                className={`text-xs flex items-center gap-1 px-3 py-1.5 rounded-md transition-colors border font-medium ${showPasteArea ? 'bg-slate-200 text-slate-700 border-slate-300' : 'bg-teal-50 text-teal-600 border-teal-200 hover:bg-teal-100'}`}
                            >
                                {showPasteArea ? <X size={14}/> : <ClipboardPaste size={14} />}
                                {showPasteArea ? t('cancel') : t('excel_paste')}
                            </button>
                            <button 
                                onClick={autoOptimize}
                                className="text-xs flex items-center gap-1 bg-indigo-50 text-indigo-600 px-3 py-1.5 rounded-md hover:bg-indigo-100 transition-colors border border-indigo-200 font-medium"
                            >
                                <Filter size={14} />
                                {t('auto_optimize')}
                            </button>
                            </div>
                        </div>
                        
                        {/* Type & Size Config */}
                        <div className="grid grid-cols-2 gap-3 mb-5 bg-slate-50 p-3 rounded-lg border border-slate-100">
                            <div>
                                <label className="block text-xs font-semibold text-slate-500 mb-1 uppercase">{t('std_type')}</label>
                                <select 
                                value={stdType} 
                                onChange={(e) => setStdType(e.target.value)}
                                className="w-full p-1.5 text-sm border border-slate-300 rounded focus:ring-1 focus:ring-teal-500 outline-none bg-white"
                                >
                                <option value="ssRNA">ssRNA (miRNA)</option>
                                <option value="dsDNA">dsDNA (Plasmid)</option>
                                </select>
                            </div>
                            <div>
                                <label className="block text-xs font-semibold text-slate-500 mb-1 uppercase">{t('std_size')}</label>
                                <div className="flex items-center gap-2">
                                <input 
                                    type="number" 
                                    value={stdSize} 
                                    onChange={(e) => setStdSize(parseFloat(e.target.value))}
                                    className="w-full p-1.5 text-sm border border-slate-300 rounded focus:ring-1 focus:ring-teal-500 outline-none"
                                />
                                <select 
                                    value={stdUnit} 
                                    onChange={(e) => setStdUnit(e.target.value)}
                                    className="p-1.5 text-sm border border-slate-300 rounded bg-white"
                                >
                                    <option value="bp">bp</option>
                                    <option value="kDa">kDa</option>
                                </select>
                                </div>
                            </div>
                        </div>

                        {/* Paste Area Overlay or Data Table */}
                        <div className="flex-1 relative">
                            
                            {showPasteArea ? (
                            <div className="absolute inset-0 z-10 bg-white flex flex-col animate-[fadeIn_0.2s_ease-out]">
                                <div className="mb-2 text-xs text-slate-500 bg-amber-50 p-2 rounded border border-amber-100">
                                {t('paste_instruction')}
                                </div>
                                <textarea
                                className="flex-1 w-full p-3 text-sm border border-slate-300 rounded-lg focus:ring-2 focus:ring-teal-500 outline-none font-mono"
                                placeholder={t('paste_placeholder')}
                                value={pasteInput}
                                onChange={(e) => setPasteInput(e.target.value)}
                                />
                                <div className="mt-3 flex gap-2">
                                <button 
                                    onClick={handlePasteProcess}
                                    className="flex-1 py-2 bg-teal-600 text-white rounded-lg hover:bg-teal-700 font-medium text-sm transition-colors"
                                >
                                    {t('confirm_import')}
                                </button>
                                <button 
                                    onClick={() => setShowPasteArea(false)}
                                    className="px-4 py-2 border border-slate-300 text-slate-600 rounded-lg hover:bg-slate-50 font-medium text-sm"
                                >
                                    {t('cancel')}
                                </button>
                                </div>
                            </div>
                            ) : (
                            <>
                                <div className="grid grid-cols-12 gap-2 text-xs font-bold text-slate-400 mb-2 px-1">
                                <div className="col-span-1 text-center"></div>
                                <div className="col-span-5">{t('col_mass')}</div>
                                <div className="col-span-4">{t('col_ct')}</div>
                                <div className="col-span-2 text-center">{t('col_del')}</div>
                                </div>
                                
                                <div className="space-y-2 max-h-[350px] overflow-y-auto pr-1">
                                {standards.map((std) => (
                                    <div key={std.id} className={`grid grid-cols-12 gap-2 items-center p-2 rounded-lg border transition-all ${std.included ? 'bg-white border-slate-200' : 'bg-slate-50 border-slate-100 opacity-60'}`}>
                                    <div className="col-span-1 flex justify-center">
                                        <input 
                                        type="checkbox"
                                        checked={std.included}
                                        onChange={(e) => handleStandardChange(std.id, 'included', e.target.checked)}
                                        className="w-4 h-4 rounded text-teal-600 focus:ring-teal-500 border-gray-300 cursor-pointer"
                                        />
                                    </div>
                                    <div className="col-span-5">
                                        <input 
                                        type="number" 
                                        step="any"
                                        value={std.quantity}
                                        onChange={(e) => handleStandardChange(std.id, 'quantity', e.target.value)}
                                        className={`w-full p-1.5 text-sm border rounded focus:border-teal-500 outline-none ${std.included ? 'border-slate-300' : 'bg-slate-50 border-transparent text-slate-400'}`}
                                        />
                                    </div>
                                    <div className="col-span-4">
                                        <input 
                                        type="number" 
                                        step="0.1"
                                        value={std.ct}
                                        onChange={(e) => handleStandardChange(std.id, 'ct', e.target.value)}
                                        className={`w-full p-1.5 text-sm border rounded focus:border-teal-500 outline-none ${std.included ? 'border-slate-300' : 'bg-slate-50 border-transparent text-slate-400'}`}
                                        />
                                    </div>
                                    <div className="col-span-2 flex justify-center">
                                        <button 
                                        onClick={() => removeStandard(std.id)}
                                        className="text-slate-300 hover:text-red-500 transition-colors"
                                        >
                                        &times;
                                        </button>
                                    </div>
                                    </div>
                                ))}
                                </div>
                                <button 
                                onClick={addStandard}
                                className="mt-3 w-full py-2 border border-dashed border-slate-300 text-slate-500 rounded-lg hover:border-teal-500 hover:text-teal-600 transition-all text-sm font-medium hover:bg-teal-50"
                                >
                                {t('btn_add_point')}
                                </button>
                            </>
                            )}
                        </div>
                        </div>

                        {/* Chart & Result Panel (Right) - Adjusted Height */}
                        <div className="lg:col-span-7 flex flex-col gap-4">
                        
                        {/* Compact Stats Row */}
                        <div className="grid grid-cols-4 gap-4 bg-slate-800 text-white p-4 rounded-xl shadow-sm items-center">
                            <div className="text-center border-r border-slate-700">
                                <div className="text-xs text-slate-400 uppercase tracking-wider mb-1">R²</div>
                                <div className={`text-2xl font-bold ${regressionParams.r2 > 0.99 ? 'text-teal-400' : regressionParams.r2 > 0.98 ? 'text-yellow-400' : 'text-red-400'}`}>
                                {regressionParams.r2 ? regressionParams.r2.toFixed(4) : '-'}
                                </div>
                            </div>
                            <div className="text-center border-r border-slate-700">
                                <div className="text-xs text-slate-400 uppercase tracking-wider mb-1">Eff %</div>
                                <div className="text-2xl font-bold text-white">
                                {regressionParams.efficiency ? regressionParams.efficiency.toFixed(1) : '-'}
                                </div>
                            </div>
                            <div className="text-center border-r border-slate-700">
                                <div className="text-xs text-slate-400 uppercase tracking-wider mb-1">Slope</div>
                                <div className="text-xl font-medium text-slate-200">
                                {regressionParams.slope ? regressionParams.slope.toFixed(3) : '-'}
                                </div>
                            </div>
                            <div className="text-center">
                                <div className="text-xs text-slate-400 uppercase tracking-wider mb-1">Intercept</div>
                                <div className="text-xl font-medium text-slate-200">
                                {regressionParams.intercept ? regressionParams.intercept.toFixed(2) : '-'}
                                </div>
                            </div>
                        </div>

                        {/* Smaller Graph Container */}
                        <div className="bg-white p-4 rounded-xl shadow-sm border border-slate-100 flex-1 min-h-[300px] max-h-[400px] flex flex-col">
                            <div className="flex justify-between items-center mb-2 px-2">
                            <h3 className="text-sm font-bold text-slate-700">{t('chart_title')}</h3>
                            <div className="flex items-center gap-2 text-xs text-slate-500">
                                <span className="flex items-center gap-1"><span className="w-2 h-2 rounded-full bg-teal-600"></span> {t('legend_included')}</span>
                                <span className="flex items-center gap-1"><span className="w-2 h-2 rounded-full bg-gray-300"></span> {t('legend_excluded')}</span>
                            </div>
                            </div>
                            
                            <div className="flex-1 w-full min-h-0">
                            <ResponsiveContainer width="100%" height="100%">
                                <LineChart margin={{ top: 10, right: 20, left: 10, bottom: 20 }}>
                                <CartesianGrid strokeDasharray="3 3" stroke="#f1f5f9" />
                                <XAxis 
                                    type="number" 
                                    dataKey="x" 
                                    name="Log Copies" 
                                    domain={['auto', 'auto']}
                                    label={{ value: 'Log2(Copies)', position: 'bottom', offset: 0, fill: '#94a3b8', fontSize: 11 }}
                                    stroke="#cbd5e1"
                                    tick={{fontSize: 11}}
                                    tickFormatter={(val) => val.toFixed(1)}
                                />
                                <YAxis 
                                    type="number" 
                                    dataKey="y" 
                                    name="Ct" 
                                    domain={['auto', 'auto']}
                                    label={{ value: 'Ct Value', angle: -90, position: 'insideLeft', fill: '#94a3b8', fontSize: 11 }}
                                    stroke="#cbd5e1"
                                    tick={{fontSize: 11}}
                                />
                                <Tooltip 
                                    cursor={{ stroke: '#cbd5e1', strokeWidth: 1 }}
                                    content={({ active, payload }) => {
                                    if (active && payload && payload.length) {
                                        const data = payload[0].payload;
                                        return (
                                        <div className="bg-white p-2 border border-slate-200 shadow-lg rounded text-xs">
                                            <p className="font-bold text-slate-700">Ct: {data.y}</p>
                                            <p className="text-slate-500">Log2 Copies: {data.x.toFixed(2)}</p>
                                            <p className={`mt-1 font-semibold ${data.original.included ? 'text-teal-600' : 'text-gray-400'}`}>
                                            {data.original.included ? 'Included' : 'Excluded'}
                                            </p>
                                        </div>
                                        );
                                    }
                                    return null;
                                    }}
                                />
                                
                                {regressionParams.slope && (
                                    <Line 
                                    dataKey="y" 
                                    data={[
                                        { x: Math.min(...regressionParams.validPoints?.map(p => Math.log2(massToCopies(p.quantity, stdSize, stdUnit, stdType)))), y: regressionParams.slope * Math.min(...regressionParams.validPoints?.map(p => Math.log2(massToCopies(p.quantity, stdSize, stdUnit, stdType)))) + regressionParams.intercept },
                                        { x: Math.max(...regressionParams.validPoints?.map(p => Math.log2(massToCopies(p.quantity, stdSize, stdUnit, stdType)))), y: regressionParams.slope * Math.max(...regressionParams.validPoints?.map(p => Math.log2(massToCopies(p.quantity, stdSize, stdUnit, stdType)))) + regressionParams.intercept }
                                    ]} 
                                    stroke="#ef4444" 
                                    strokeWidth={2} 
                                    dot={false} 
                                    activeDot={false}
                                    isAnimationActive={false}
                                    />
                                )}

                                <Scatter 
                                    data={standards.filter(p => p.quantity > 0 && p.ct > 0).map(p => ({
                                    x: Math.log2(massToCopies(p.quantity, stdSize, stdUnit, stdType)),
                                    y: p.ct,
                                    original: p
                                    }))} 
                                    shape={(props) => {
                                    const { cx, cy, payload } = props;
                                    return (
                                        <circle 
                                        cx={cx} cy={cy} r={5} 
                                        fill={payload.original.included ? "#0d9488" : "#cbd5e1"} 
                                        stroke={payload.original.included ? "#0f766e" : "#94a3b8"}
                                        strokeWidth={1}
                                        className="transition-all duration-300"
                                        />
                                    );
                                    }}
                                />
                                </LineChart>
                            </ResponsiveContainer>
                            </div>
                        </div>
                        </div>
                    </div>
                    )}


                    {/* --- TAB 2: SAMPLE CALCULATION --- */}
                    {activeTab === 'sample' && (
                    <div className="grid lg:grid-cols-12 gap-6 animate-[fadeIn_0.3s_ease-out]">
                        
                        {/* Left Col: Inputs */}
                        <div className="lg:col-span-5 space-y-4">
                        <div className="bg-white p-6 rounded-xl shadow-sm border border-slate-100">
                            <h2 className="text-lg font-semibold mb-4 text-slate-800">
                            {t('sample_params')}
                            </h2>

                            {/* Warning if no standard curve */}
                            {!regressionParams.slope && (
                            <div className="mb-4 p-3 bg-amber-50 text-amber-700 text-sm rounded-lg flex items-start gap-2 border border-amber-200">
                                <Info className="w-4 h-4 mt-0.5 flex-shrink-0" />
                                {t('warning_no_std')}
                            </div>
                            )}

                            <div className="space-y-5">
                            <div>
                                <label className="block text-sm font-medium text-slate-700 mb-1">
                                {t('ev_input')}
                                </label>
                                <div className="relative group">
                                <input 
                                    type="number" 
                                    step="1e8"
                                    value={evInput}
                                    onChange={(e) => setEvInput(parseFloat(e.target.value))}
                                    className="w-full pl-3 pr-12 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-teal-500 outline-none transition-all"
                                />
                                <span className="absolute right-3 top-2 text-slate-400 text-sm">{t('units_particles')}</span>
                                </div>
                                <div className="text-xs text-slate-400 mt-1 pl-1">
                                {t('scientific_notation')}: {evInput > 0 ? evInput.toExponential(2) : '-'}
                                </div>
                            </div>

                            {/* Extraction Info */}
                            <div className="p-3 bg-slate-50 rounded-lg border border-slate-100">
                                <div className="text-xs font-bold text-slate-400 uppercase tracking-wider mb-2">{t('rna_extraction')}</div>
                                <div className="grid grid-cols-2 gap-3">
                                    <div>
                                    <label className="block text-xs font-medium text-slate-600 mb-1">{t('eluted_conc')}</label>
                                    <div className="relative">
                                        <input 
                                        type="number" 
                                        value={rnaConc}
                                        onChange={(e) => setRnaConc(parseFloat(e.target.value))}
                                        className="w-full pl-2 pr-10 py-1.5 text-sm border border-slate-300 rounded focus:ring-1 focus:ring-teal-500 outline-none"
                                        />
                                        <span className="absolute right-2 top-1.5 text-slate-400 text-xs">ng/µL</span>
                                    </div>
                                    </div>
                                    <div>
                                    <label className="block text-xs font-medium text-slate-600 mb-1">{t('elution_vol')}</label>
                                    <div className="relative">
                                        <input 
                                        type="number" 
                                        value={rnaVol}
                                        onChange={(e) => setRnaVol(parseFloat(e.target.value))}
                                        className="w-full pl-2 pr-8 py-1.5 text-sm border border-slate-300 rounded focus:ring-1 focus:ring-teal-500 outline-none"
                                        />
                                        <span className="absolute right-2 top-1.5 text-slate-400 text-xs">µL</span>
                                    </div>
                                    </div>
                                </div>
                            </div>
                            
                            {/* qPCR Info */}
                            <div className="p-3 bg-slate-50 rounded-lg border border-slate-100">
                                <div className="text-xs font-bold text-slate-400 uppercase tracking-wider mb-2">{t('qpcr_reaction')}</div>
                                <div className="grid grid-cols-2 gap-3 mb-3">
                                    <div>
                                        <label className="block text-xs font-medium text-slate-600 mb-1">{t('input_rna_mass')}</label>
                                        <div className="relative">
                                        <input 
                                            type="number" 
                                            value={qpcrInputMass}
                                            onChange={(e) => setQpcrInputMass(parseFloat(e.target.value))}
                                            className="w-full pl-2 pr-8 py-1.5 text-sm border border-slate-300 rounded focus:ring-1 focus:ring-teal-500 outline-none"
                                        />
                                        <span className="absolute right-2 top-1.5 text-slate-400 text-xs">ng</span>
                                        </div>
                                    </div>
                                    <div>
                                        <label className="block text-xs font-medium text-teal-700 mb-1 font-bold">{t('target_product')}</label>
                                        <div className="flex gap-1">
                                            <div className="relative flex-1">
                                                <input 
                                                    type="number" 
                                                    value={targetSize}
                                                    onChange={(e) => setTargetSize(parseFloat(e.target.value))}
                                                    className="w-full pl-2 pr-8 py-1.5 text-sm border border-teal-300 rounded focus:ring-1 focus:ring-teal-500 outline-none bg-teal-50"
                                                />
                                                <span className="absolute right-1 top-1.5 text-teal-600 text-[10px]">{stdUnit}</span>
                                            </div>
                                            <select 
                                                value={targetType}
                                                onChange={(e) => setTargetType(e.target.value)}
                                                className="w-16 p-1 text-[10px] border border-teal-300 rounded focus:ring-1 focus:ring-teal-500 outline-none bg-teal-50 text-teal-800"
                                            >
                                                <option value="ssRNA">ssRNA</option>
                                                <option value="dsDNA">dsDNA</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                                <p className="text-[10px] text-slate-400 mb-3">
                                    {t('target_diff_hint')}
                                </p>
                                
                                <label className="block text-sm font-bold text-slate-800 mb-1">
                                {t('sample_ct')}
                                </label>
                                <input 
                                type="number" 
                                value={sampleCt}
                                onChange={(e) => setSampleCt(parseFloat(e.target.value))}
                                className="w-full p-2 border-2 border-teal-200 rounded-lg focus:border-teal-500 outline-none text-xl font-mono text-center text-teal-800 font-bold bg-white"
                                />
                            </div>

                            </div>
                        </div>
                        </div>

                        {/* Right Col: Results */}
                        <div className="lg:col-span-7">
                        <div className="bg-white rounded-xl shadow-lg border border-slate-100 overflow-hidden h-full flex flex-col">
                            <div className="bg-teal-700 px-6 py-4 flex justify-between items-center text-white">
                            <h2 className="font-semibold text-lg flex items-center gap-2">
                                <ArrowRight className="w-5 h-5" /> {t('analysis_report')}
                            </h2>
                            <button className="text-teal-200 hover:text-white transition-colors" title={t('reset')} onClick={() => setSampleCt(0)}>
                                <RotateCcw size={18} />
                            </button>
                            </div>
                            
                            {results ? (
                            <div className="p-6 flex-1 flex flex-col">
                                
                                {/* Primary Results */}
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                                
                                {/* Copies Result */}
                                <div className="bg-indigo-50 p-4 rounded-xl border border-indigo-100 relative group">
                                    <div className="text-indigo-600 text-xs font-bold uppercase tracking-wider mb-1">{t('copies_per_ev')}</div>
                                    <div className="text-2xl font-extrabold text-indigo-900 break-all">
                                    {results.copiesPerEv.toExponential(2)}
                                    </div>
                                    <div className="text-[10px] text-indigo-400 mt-1">{t('target_gene_copies')}</div>
                                    <button 
                                    className="absolute top-2 right-2 opacity-0 group-hover:opacity-100 transition-opacity text-indigo-400 hover:text-indigo-600"
                                    onClick={() => navigator.clipboard.writeText(results.copiesPerEv.toExponential(3))}
                                    >
                                    <Copy size={14} />
                                    </button>
                                </div>

                                {/* Target Mass Result (NEW) */}
                                <div className="bg-teal-50 p-4 rounded-xl border border-teal-100 relative group">
                                    <div className="text-teal-700 text-xs font-bold uppercase tracking-wider mb-1">{t('target_mass_per_ev')}</div>
                                    <div className="text-2xl font-extrabold text-teal-900 flex items-baseline gap-1">
                                    {results.targetMassPerEvPg.toExponential(2)} <span className="text-sm font-normal text-teal-600">pg</span>
                                    </div>
                                    <div className="text-[10px] text-teal-500 mt-1">{t('specific_target_mass')} ({targetSize}{stdUnit}, {targetType})</div>
                                    <button 
                                    className="absolute top-2 right-2 opacity-0 group-hover:opacity-100 transition-opacity text-teal-500 hover:text-teal-700"
                                    onClick={() => navigator.clipboard.writeText(results.targetMassPerEvPg.toExponential(2))}
                                    >
                                    <Copy size={14} />
                                    </button>
                                </div>
                                </div>
                                
                                {/* Additional Metrics */}
                                <div className="bg-slate-50 rounded-lg p-4 border border-slate-100 mb-6">
                                    <div className="flex justify-between items-center">
                                        <div>
                                            <div className="text-xs text-slate-500 uppercase font-semibold">{t('total_rna_yield')}</div>
                                            <div className="text-[10px] text-slate-400">{t('derived_bulk')}</div>
                                        </div>
                                        <div className="text-right">
                                            <div className="text-lg font-bold text-slate-700">{results.totalRnaMassPerEv.toExponential(2)} pg</div>
                                        </div>
                                    </div>
                                </div>

                                {/* Calculation Steps (Collapsible or Small) */}
                                <div className="mt-auto border-t border-slate-100 pt-4">
                                <h3 className="text-xs font-bold text-slate-400 uppercase mb-3">{t('traceability')}</h3>
                                <div className="grid grid-cols-2 gap-x-8 gap-y-2 text-xs text-slate-600">
                                    <div className="flex justify-between border-b border-dashed border-slate-100 pb-1">
                                    <span>{t('est_copies_well')}</span>
                                    <span className="font-mono">{results.copiesInWell.toExponential(2)}</span>
                                    </div>
                                    <div className="flex justify-between border-b border-dashed border-slate-100 pb-1">
                                    <span>{t('total_rna_yield_val')}</span>
                                    <span className="font-mono">{results.totalRnaYieldNg.toFixed(1)} ng</span>
                                    </div>
                                    <div className="flex justify-between border-b border-dashed border-slate-100 pb-1">
                                    <span>{t('total_copies_sample')}</span>
                                    <span className="font-mono">{results.totalCopiesInEluate.toExponential(2)}</span>
                                    </div>
                                    <div className="flex justify-between border-b border-dashed border-slate-100 pb-1">
                                    <span>{t('sample_mw_used')}</span>
                                    <span className="font-mono">{calculateMW(targetSize, stdUnit, targetType).toFixed(0)} Da</span>
                                    </div>
                                </div>
                                </div>

                            </div>
                            ) : (
                            <div className="h-full flex flex-col items-center justify-center text-slate-400 p-10">
                                <Calculator size={48} className="mb-4 opacity-20" />
                                <p>{t('waiting_input')}</p>
                            </div>
                            )}
                        </div>
                        </div>
                    </div>
                    )}

                    {/* --- TAB 3: BATCH CALCULATION --- */}
                    {activeTab === 'batch' && (
                    <div className="animate-[fadeIn_0.3s_ease-out]">
                        
                        {/* Batch Header / Warning */}
                        {!regressionParams.slope && (
                            <div className="mb-6 p-4 bg-amber-50 text-amber-700 rounded-xl border border-amber-200 flex items-center gap-3 shadow-sm">
                                <Info className="w-5 h-5 flex-shrink-0" />
                                <div>
                                    <div className="font-bold">{t('batch_warning_title')}</div>
                                    <div className="text-sm opacity-90">{t('batch_warning_desc')}</div>
                                </div>
                            </div>
                        )}

                        {/* Config Bar */}
                        <div className="bg-white p-4 rounded-xl shadow-sm border border-slate-100 mb-6 flex items-center justify-between flex-wrap gap-4">
                            <div className="flex items-center gap-4">
                                <div className="flex items-center gap-2 text-sm text-slate-600 bg-slate-50 px-3 py-1.5 rounded-lg border border-slate-200">
                                    <span className="text-slate-400">{t('target_product')}:</span>
                                    <input 
                                        type="number" 
                                        className="w-16 bg-transparent border-b border-slate-300 focus:border-teal-500 outline-none text-center font-bold text-teal-700"
                                        value={targetSize}
                                        onChange={(e) => setTargetSize(parseFloat(e.target.value))}
                                    />
                                    <span className="text-xs font-medium mr-1">{stdUnit}</span>
                                    <select 
                                        value={targetType}
                                        onChange={(e) => setTargetType(e.target.value)}
                                        className="p-1 text-xs border border-slate-200 rounded outline-none bg-white text-slate-700 font-medium"
                                    >
                                        <option value="ssRNA">ssRNA</option>
                                        <option value="dsDNA">dsDNA</option>
                                    </select>
                                </div>
                            </div>
                            <div className="flex gap-2">
                                <button 
                                    onClick={() => setShowBatchPaste(!showBatchPaste)}
                                    className="flex items-center gap-2 px-4 py-2 bg-teal-600 text-white rounded-lg hover:bg-teal-700 transition-colors shadow-sm text-sm font-medium"
                                >
                                    {showBatchPaste ? <TableIcon size={16}/> : <FileSpreadsheet size={16}/>}
                                    {showBatchPaste ? t('view_table') : t('paste_batch_data')}
                                </button>
                            </div>
                        </div>

                        {/* Content Area */}
                        <div className="bg-white rounded-xl shadow-sm border border-slate-100 min-h-[500px] overflow-hidden">
                            
                            {showBatchPaste ? (
                                <div className="p-8 flex flex-col h-full items-center justify-center">
                                    <div className="max-w-2xl w-full">
                                        <h2 className="text-xl font-bold text-slate-800 mb-4 flex items-center gap-2">
                                            <FileSpreadsheet className="text-teal-600"/> 
                                            {t('batch_input_title')}
                                        </h2>
                                        <div className="mb-4 text-sm text-slate-600 bg-slate-50 p-4 rounded-lg border border-slate-200 space-y-2">
                                            <p className="font-semibold text-slate-700">{t('batch_instruction')}</p>
                                            <div className="flex gap-2 font-mono text-xs bg-white p-2 border rounded overflow-x-auto">
                                                {t('batch_cols')}
                                            </div>
                                            <p className="text-xs text-slate-400">{t('batch_example')}</p>
                                        </div>
                                        
                                        <textarea
                                            className="w-full h-64 p-4 text-sm border border-slate-300 rounded-xl focus:ring-2 focus:ring-teal-500 outline-none font-mono mb-4 shadow-inner resize-none"
                                            placeholder={t('batch_placeholder')}
                                            value={batchPasteInput}
                                            onChange={(e) => setBatchPasteInput(e.target.value)}
                                        />
                                        
                                        <button 
                                            onClick={handleBatchPasteProcess}
                                            disabled={!regressionParams.slope}
                                            className={`w-full py-3 rounded-xl font-bold text-lg shadow-md transition-all ${
                                                !regressionParams.slope 
                                                ? 'bg-slate-200 text-slate-400 cursor-not-allowed' 
                                                : 'bg-teal-600 text-white hover:bg-teal-700 hover:shadow-lg'
                                            }`}
                                        >
                                            {t('start_calc')} ({batchPasteInput ? batchPasteInput.trim().split(/\n/).length : 0})
                                        </button>
                                    </div>
                                </div>
                            ) : (
                                <div className="flex flex-col h-full">
                                    <div className="overflow-x-auto flex-1">
                                        {batchSamples.length > 0 ? (
                                            <table className="w-full text-sm text-left">
                                                <thead className="text-xs text-slate-500 uppercase bg-slate-50 border-b border-slate-200">
                                                    <tr>
                                                        <th className="px-6 py-3 font-bold">{t('col_name')}</th>
                                                        <th className="px-6 py-3">Copies / EV</th>
                                                        <th className="px-6 py-3">Target Mass / EV (pg)</th>
                                                        <th className="px-6 py-3 text-slate-400">Ct</th>
                                                        <th className="px-6 py-3 text-slate-400">EV Input</th>
                                                    </tr>
                                                </thead>
                                                <tbody className="divide-y divide-slate-100">
                                                    {batchSamples.map((sample) => (
                                                        <tr key={sample.id} className="hover:bg-slate-50 transition-colors">
                                                            <td className="px-6 py-4 font-medium text-slate-900">{sample.name}</td>
                                                            <td className="px-6 py-4 font-mono text-indigo-700 font-bold bg-indigo-50/30">
                                                                {sample.copiesPerEv.toExponential(2)}
                                                            </td>
                                                            <td className="px-6 py-4 font-mono text-teal-700 font-bold bg-teal-50/30">
                                                                {sample.targetMassPerEvPg.toExponential(2)}
                                                            </td>
                                                            <td className="px-6 py-4 text-slate-500">{sample.ct}</td>
                                                            <td className="px-6 py-4 text-slate-400 text-xs">{sample.evIn.toExponential(1)}</td>
                                                        </tr>
                                                    ))}
                                                </tbody>
                                            </table>
                                        ) : (
                                            <div className="flex flex-col items-center justify-center h-64 text-slate-400">
                                                <TableIcon size={48} className="opacity-20 mb-2"/>
                                                <p>{t('no_results')}</p>
                                            </div>
                                        )}
                                    </div>
                                    {batchSamples.length > 0 && (
                                        <div className="p-4 border-t border-slate-100 bg-slate-50 flex justify-end">
                                            <p className="text-xs text-slate-400 mr-auto self-center">
                                                {t('copy_hint')}
                                            </p>
                                        </div>
                                    )}
                                </div>
                            )}
                        </div>
                    </div>
                    )}

                </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>